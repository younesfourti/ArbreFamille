function getContainer(){return document.getElementById("arbre-famille")}function getContainerSize(){const e=getContainer();return{width:e.clientWidth,height:e.clientHeight}}let width,height;const nodeWidth=140,nodeHeight=60,horizontalGap=40,groupeInterMemberGap=15,verticalGap=100,highlightColor="#DAA520";let stage,layer,groupDrag,backgroundRect,selectedMemberId=null,highlightSet=new Set;function computeHighlightSet(e){const i=new Set,n=window.membres.find((i=>i.id===e));return n?(i.add(e),n.fid&&i.add(n.fid),n.mid&&i.add(n.mid),n.pid&&i.add(n.pid),Array.isArray(n.expids)&&n.expids.forEach((e=>i.add(e))),window.membres.forEach((n=>{n.fid!==e&&n.mid!==e||i.add(n.id)})),n.fid&&n.mid&&window.membres.forEach((t=>{t.id!==e&&t.fid===n.fid&&t.mid===n.mid&&i.add(t.id)})),i):i}function isExConjointId(e){return window.membres.some((i=>Array.isArray(i.expids)&&i.expids.includes(e)))}const onResize=()=>{const e=getContainerSize();stage.width(e.width),stage.height(e.height),layer.batchDraw()};function initStage(){const e=getContainerSize();width=e.width,height=e.height,stage=new Konva.Stage({container:"arbre-famille",width:e.width,height:e.height}),layer=new Konva.Layer,stage.add(layer),backgroundRect=new Konva.Rect({x:0,y:0,width:stage.width(),height:stage.height(),fill:"transparent",listening:!0}),layer.add(backgroundRect),groupDrag=new Konva.Group({draggable:!0}),layer.add(groupDrag),backgroundRect.remove(),groupDrag.add(backgroundRect),groupDrag.moveToBottom(),groupDrag.on("dragstart touchstart",(()=>{document.body.style.cursor="grabbing"})),groupDrag.on("dragend touchend",(()=>{document.body.style.cursor="default"})),stage.on("wheel",(e=>{e.evt.preventDefault();const i=layer.scaleX(),n=stage.getPointerPosition();let t=(e.evt.deltaY>0?1:-1)>0?i/1.05:1.05*i;t=Math.max(.5,Math.min(3,t));const d=(n.x-layer.x())/i,r=(n.y-layer.y())/i;layer.scale({x:t,y:t});const o={x:n.x-d*t,y:n.y-r*t};layer.position(o),layer.batchDraw()})),window.removeEventListener("resize",onResize),window.addEventListener("resize",onResize)}function drawMember(e,i,n){const t=new Konva.Group({x:i,y:n}),d=new Konva.Rect({width:140,height:60,fill:"male"===e.gender?"#D0EBFF":"#FFE3E3",stroke:"#A5A5A5",strokeWidth:2,cornerRadius:10,shadowColor:"#000",shadowOpacity:.1,shadowBlur:5,shadowOffset:{x:0,y:2}}),r=new Konva.Text({text:e.name,width:140,height:60,align:"center",verticalAlign:"middle",fontSize:12,fontFamily:"Plus Jakarta Sans",fill:"#1E293B",fontStyle:"bold"}),o=getBadgeText(e),s=getBadgeColor(e);if(o){const e=new Konva.Text({text:o,fontSize:9,fontFamily:"Plus Jakarta Sans"}).width()+20,i=20,n=new Konva.Rect({x:(140-e)/2,y:60-i-5,width:e,height:i,fill:s,cornerRadius:i/2}),d=new Konva.Text({x:(140-e)/2,y:60-i-5,width:e,height:i,text:o,fontSize:9,fontFamily:"Plus Jakarta Sans",fill:"#FFF",align:"center",verticalAlign:"middle",fontStyle:"normal"});t.add(n),t.add(d)}t.add(d),t.add(r);const l=new Konva.Group({x:125,y:5,visible:!1,listening:!0}),a=new Konva.Rect({width:12,height:12,fill:"#fff",stroke:"red",strokeWidth:1,cornerRadius:2}),m=new Konva.Text({text:"✖",fontSize:10,width:12,height:12,align:"center",verticalAlign:"middle",fill:"red"});let u;l.add(a),l.add(m),t.add(l),l.on("mouseenter",(()=>{document.body.style.cursor="pointer"})),l.on("mouseleave",(()=>{document.body.style.cursor="default"})),l.on("click",(()=>{"function"==typeof window.removeMemberById&&window.removeMemberById(e.id)})),groupDrag.add(t),e.group=t,t.on("click",(()=>{selectedMemberId===e.id?(selectedMemberId=null,highlightSet=new Set):(selectedMemberId=e.id,highlightSet=computeHighlightSet(e.id)),renderTree()}));if(!(isExConjointId(e.id)||e.fid&&e.mid)){const i=5,n=10.5;u=new Konva.Group({x:70,y:0,listening:!0,visible:!1});const d=new Konva.Circle({x:0,y:0,radius:i,fill:"#eee",stroke:"#666666",strokeWidth:2}),r=new Konva.Text({x:0,y:0,text:"+",fontSize:18,fontWeight:"bold",fill:"#666666",visible:!1});u.add(d),u.add(r),t.add(u),u.on("mouseenter",(()=>{document.body.style.cursor="pointer",d.radius(n),d.fill("#D1E8FF"),r.visible(!0),layer.draw()})),u.on("mouseleave",(()=>{document.body.style.cursor="default",d.radius(i),d.fill("#eee"),r.visible(!1),layer.draw()})),u.on("click",(()=>{const i=Math.max(0,...window.membres.map((e=>e.id)))+1,n={...e},t={id:i};let d=null;if(e.fid||e.mid)if(e.fid){if(e.mid)return;t.name="mèreTest",t.gender="female",d=e.fid,d&&(t.pid=d),n.mid=i}else t.name="pèreTest",t.gender="male",d=e.mid,d&&(t.pid=d),n.fid=i;else t.name="pèreTest",t.gender="male",n.fid=i;const r=window.membres.map((t=>t.id===e.id?n:d&&t.id===d?{...t,pid:i}:t));r.push(t),"function"==typeof window.updateMembresJSON?window.updateMembresJSON(r):(window.membres=r,renderTree())}))}t.on("mouseenter",(()=>{l.visible(!0),u&&u.visible(!0),layer.draw()})),t.on("mouseleave",(()=>{l.visible(!1),u&&u.visible(!1),layer.draw()}))}function getBadgeText(e){const i=window.membres.some((i=>i.fid===e.id||i.mid===e.id)),n=e.pid,t=e.expids&&e.expids.length>0;return i&&n?"Petit enfant":i?"Enfant":n||t?"Beau enfant":"Petit enfant"}function getBadgeColor(e){switch(getBadgeText(e)){case"Enfant":return"#3B82F6";case"Petit enfant":return"#60A5FA";case"Beau enfant":return"#8B5CF6";default:return"#6B7280"}}function calculerEtAjusterNiveaux(e){e.forEach((e=>e.lvl=null));const i=[];for(e.forEach((e=>{e.fid||e.mid||(e.lvl=1,i.push(e))}));i.length>0;){const n=i.shift(),t=[];if(n.expids&&n.expids.length>0&&n.expids.forEach((i=>{const n=e.find((e=>e.id===i));n&&t.push(n)})),n.pid){const i=e.find((e=>e.id===n.pid));i&&t.push(i)}t.forEach((e=>{(null===e.lvl||e.lvl<n.lvl)&&(e.lvl=n.lvl,i.push(e))}));e.filter((e=>e.fid===n.id||e.mid===n.id)).forEach((e=>{const t=n.lvl+1;(null===e.lvl||e.lvl<t)&&(e.lvl=t,i.push(e))}));const d=[];n.fid&&d.push(e.find((e=>e.id===n.fid))),n.mid&&d.push(e.find((e=>e.id===n.mid))),d.filter(Boolean).forEach((e=>{const t=n.lvl-1;t>0&&(null===e.lvl||e.lvl<t)&&(e.lvl=t,i.push(e))}))}const n=Math.max(...e.map((e=>e.lvl||1)));e.forEach((e=>{null===e.lvl&&(e.lvl=n+1)}))}function constituerGroupesConjoints(e){const i=[],n=new Set(e);return e.forEach((t=>{if(!n.has(t))return;const d=function(i){let n=null;if(i.pid){const t=e.find((e=>e.id===i.pid));t&&t.pid===i.id&&(n=t)}let t=i,d=n;d&&"male"===d.gender&&"female"===t.gender&&([t,d]=[d,t]);let r=[];t.expids&&t.expids.length&&(r=t.expids.map((i=>e.find((e=>e.id===i)))).filter(Boolean).reverse());let o,s=[];return d&&d.expids&&d.expids.length&&(s=d.expids.map((i=>e.find((e=>e.id===i)))).filter(Boolean)),o=d?[...r,t,d,...s]:r.length>0?[...r.reverse(),t]:[t],o=[...new Set(o)],o}(t);i.push(d),d.forEach((e=>n.delete(e)))})),i}function getFreresSoeurs(e,i){return e.fid&&e.mid?membres.filter((n=>!(n.lvl!==i||n.fid!==e.fid||n.mid!==e.mid||n.id===e.id||n.pid||n.expids&&n.expids.length>0))):[]}function creerGroupesNiveaux(e,i){const n=[...new Set(e.map((e=>e.lvl)))].sort(),t=[];return n.forEach((n=>{let d=i.filter((e=>e.some((e=>e.lvl===n))));const r=i=>{const n=e.filter((e=>i.some((i=>e.fid===i.id||e.mid===i.id)))).map((e=>e.id));return n.length>0?Math.min(...n):Math.min(...i.map((e=>e.id)))},o=(i,n)=>{const t=e.find((e=>e.id===i)),d=e.find((e=>e.id===n));if(!t||!d||null==t.x||null==d.x)return null;return(t.x+70+(d.x+70))/2},s=[],l=[];d.forEach((e=>{const i=e.find((e=>e.fid&&e.mid));if(!i)return void l.push(e);const n=`${i.fid}-${i.mid}`;let t=s.find((e=>e.key===n));t||(t={key:n,join:o(i.fid,i.mid),groups:[]},s.push(t)),t.groups.push(e)})),s.sort(((e,i)=>{if(null!=e.join&&null!=i.join)return e.join-i.join;if(null!=e.join)return-1;if(null!=i.join)return 1;return Math.min(...e.groups.map(r))-Math.min(...i.groups.map(r))})),d=s.flatMap((e=>e.groups)).concat(l);const a=100*(n-1)+20,m=[],u=new Set;d.forEach((i=>{if(i.every((e=>u.has(e.id))))return;let t=i.find((i=>i.pid&&e.find((e=>e.id===i.pid))))||null,d=t?e.find((e=>e.id===t.pid)):null;t&&d&&"female"===t.gender&&"male"===d.gender&&([t,d]=[d,t]);const r=t&&d?getFreresSoeurs(t,n).filter((e=>!u.has(e.id))):[],o=t&&d?getFreresSoeurs(d,n).filter((e=>!u.has(e.id))):[],s=i.filter((e=>!u.has(e.id))),l=[...r,...s,...o];0!==l.length&&(m.push({membres:l,gc:i,gcMembers:s,fsGauche:r,fsDroite:o,baseY:a}),l.forEach((e=>u.add(e.id))))}));const f=m.map((i=>{const n=[];i.fsGauche.length>0&&n.push({members:i.fsGauche,gap:40}),i.gcMembers.length>0&&n.push({members:i.gcMembers,gap:15}),i.fsDroite.length>0&&n.push({members:i.fsDroite,gap:40});const t=n.reduce(((e,i,n)=>e+(140*i.members.length+(i.members.length-1)*i.gap)+(n>0?40:0)),0),d=i.gc.find((e=>e.fid&&e.mid));let r=null;if(d){const i=e.find((e=>e.id===d.fid)),n=e.find((e=>e.id===d.mid));if(i&&n&&null!=i.x&&null!=n.x){r=(i.x+70+(n.x+70))/2}}return{bloc:i,w:t,join:r,groups:n}}));let c=0;f.forEach((e=>{let i=null!==e.join?e.join:c+e.w/2,n=i-e.w/2;n<c&&(n=c,i=n+e.w/2),e.cx=i,e.start=n,c=n+e.w+40})),f.forEach((e=>{let i=e.start;e.groups.forEach(((n,t)=>{n.members.forEach(((t,d)=>{t.x=i+d*(140+n.gap),t.y=e.bloc.baseY})),i+=140*n.members.length+(n.members.length-1)*n.gap,t<e.groups.length-1&&(i+=40)}))}));const h=width/2,g=f.flatMap((e=>e.bloc.membres)),p=h-(Math.min(...g.map((e=>e.x)))+Math.max(...g.map((e=>e.x+140))))/2;g.forEach((e=>{e.x+=p})),t.push({niveau:n,gfs:m})})),t}function positionnerGroupesConjointsParNiveau(e,i){[...new Set(e.map((e=>e.lvl)))].sort().forEach((n=>{let t=i.filter((e=>e.some((e=>e.lvl===n))));console.log(`\n== Traitement niveau ${n} ==`),t.forEach(((e,i)=>{const n=e.map((e=>e.name)).join(", ");console.log(`  Groupe ${i} avant tri: [${n}]`)}));const d=i=>{const n=e.filter((e=>i.some((i=>e.fid===i.id||e.mid===i.id)))).map((e=>e.id));return n.length>0?Math.min(...n):Math.min(...i.map((e=>e.id)))},r=(i,n)=>{const t=e.find((e=>e.id===i)),d=e.find((e=>e.id===n));if(!t||!d||null==t.x||null==d.x)return null;return(t.x+70+(d.x+70))/2},o=[],s=[];if(t.forEach((e=>{const i=e.find((e=>e.fid&&e.mid));if(!i)return void s.push(e);const n=`${i.fid}-${i.mid}`;let t=o.find((e=>e.key===n));t||(t={key:n,join:r(i.fid,i.mid),groups:[]},o.push(t)),t.groups.push(e)})),o.sort(((e,i)=>{if(null!=e.join&&null!=i.join)return e.join-i.join;if(null!=e.join)return-1;if(null!=i.join)return 1;return Math.min(...e.groups.map(d))-Math.min(...i.groups.map(d))})),t=o.flatMap((e=>e.groups)).concat(s),console.log("  Ordre après tri:"),t.forEach(((e,i)=>{const n=e.find((e=>e.fid&&e.mid)),t=n?r(n.fid,n.mid):null;console.log(`    ${i}: [${e.map((e=>e.name)).join(", ")}] jp=${t}`)})),0===t.length)return;const l=100*(n-1)+20,a=[],m=new Set;t.forEach((i=>{if(i.every((e=>m.has(e.id))))return;let t=i.find((i=>i.pid&&e.find((e=>e.id===i.pid))))||null,d=t?e.find((e=>e.id===t.pid)):null;t&&d&&"female"===t.gender&&"male"===d.gender&&([t,d]=[d,t]);const r=t&&d?getFreresSoeurs(t,n).filter((e=>!m.has(e.id))):[],o=t&&d?getFreresSoeurs(d,n).filter((e=>!m.has(e.id))):[];r.length>0&&(a.push({membres:r,label:"FS P1"}),r.forEach((e=>m.add(e.id))));const s=t&&d?"Groupe conjoint":"Groupe seul",l=i.filter((e=>!m.has(e.id)));l.length>0&&(a.push({membres:l,label:s}),l.forEach((e=>m.add(e.id)))),o.length>0&&(a.push({membres:o,label:"FS P2"}),o.forEach((e=>m.add(e.id))))})),console.log(`Niveau ${n} : ordre des blocs`),a.forEach(((e,i)=>{console.log(`Bloc ${i}: ${e.label} => [${e.membres.map((e=>e.name)).join(", ")}]`)}));const u=a.map((i=>{const n=140*i.membres.length+15*(i.membres.length-1),t=i.membres.find((e=>e.fid&&e.mid));let d=null;if(t){const i=e.find((e=>e.id===t.fid)),n=e.find((e=>e.id===t.mid));if(i&&n&&null!=i.x&&null!=n.x){d=(i.x+70+(n.x+70))/2}}const r=i.membres.map((e=>e.name)).join(", ");return console.log(`  Bloc ${r} => width:${n} join:${d}`),{bloc:i,w:n,join:d}}));let f=0;u.forEach((e=>{let i=null!==e.join?e.join:f+e.w/2,n=i-e.w/2;n<f&&(n=f,i=n+e.w/2),e.cx=i,f=n+e.w+40}));const c=width/2-(f-40)/2;u.forEach((e=>{const i=e.cx-e.w/2+c;e.bloc.membres.forEach(((e,n)=>{e.x=i+155*n,e.y=l})),console.log(`  Placement bloc [${e.bloc.membres.map((e=>e.name)).join(", ")}] at cx=${e.cx+c} (width ${e.w}) join=${e.join}`)}))}))}function centrerTousLesMembres(e){if(0===e.length)return;const i=width/2-(Math.min(...e.map((e=>e.x)))+Math.max(...e.map((e=>e.x+140))))/2;e.forEach((e=>{e.x+=i}))}function trouverPartenairesPrincipaux(e){let i=null,n=null;return e.forEach((t=>{if(t.pid){const d=e.find((e=>e.id===t.pid&&e.pid===t.id));d&&(i=t,n=d)}})),i&&n&&e.indexOf(i)>e.indexOf(n)&&([i,n]=[n,i]),i||(i=e[0]),{p1:i,p2:n}}function dessinerNoeudsGroupesConjoints(e){const i=10.5;function n(e,i){if(!e)return;const n=Math.max(0,...window.membres.map((e=>e.id)))+1,t={id:n,name:"expidTest",gender:i},d=window.membres.map((i=>{if(i.id===e.id){const e=Array.isArray(i.expids)?[...i.expids,n]:[n];return{...i,expids:e}}return i}));d.push(t),"function"==typeof window.updateMembresJSON?window.updateMembresJSON(d):(window.membres=d,renderTree())}e.forEach((e=>{for(let n=0;n<e.length-1;n++){const t=e[n],d=e[n+1],r=t.y+30,o=t.x+140,s=d.x,l=selectedMemberId&&(t.id===selectedMemberId&&highlightSet.has(d.id)||d.id===selectedMemberId&&highlightSet.has(t.id));groupDrag.add(new Konva.Line({points:[o,r,s,r],stroke:l?"#DAA520":"#666",strokeWidth:2,listening:!1}));const a=(o+s)/2,m=new Konva.Group({x:a,y:r,listening:!0}),u=new Konva.Circle({x:0,y:0,radius:5,fill:"#eee",stroke:"#666",strokeWidth:2}),f=new Konva.Text({x:-5,y:-8,text:"+",fontSize:18,fontWeight:"bold",fill:"#666",visible:!1});m.add(u),m.add(f),groupDrag.add(m),m.on("mouseenter",(()=>{console.log("mouseenter sur noeud entre",t.name,d.name),document.body.style.cursor="pointer",u.radius(i),u.fill("yellow"),f.visible(!0),m.moveToTop(),layer.draw()})),m.on("mouseleave",(()=>{document.body.style.cursor="default",u.radius(5),u.fill("#eee"),f.visible(!1),layer.draw()})),m.on("click",(()=>{let i,n;if(t.gender!==d.gender)"male"===t.gender?(i=t.id,n=d.id):(i=d.id,n=t.id);else{const r=window.membres.find((e=>e.expids&&e.expids.includes(t.id)&&e.expids.includes(d.id)));if(r){const o=e.indexOf(r),s=e.indexOf(t),l=e.indexOf(d);if(s<o&&l<o){const t=Math.min(s,l),d=e[t];"male"===r.gender?(i=r.id,n=d.id):(i=d.id,n=r.id)}else if(s>o&&l>o){const t=Math.max(s,l),d=e[t];"male"===r.gender?(i=r.id,n=d.id):(i=d.id,n=r.id)}else{const t=Math.min(s,l),d=e[t];"male"===r.gender?(i=r.id,n=d.id):(i=d.id,n=r.id)}}else i=t.id,n=d.id}const r=i+","+n,o={id:Math.max(0,...window.membres.map((e=>e.id)))+1,fid:i,mid:n,name:"testJS",gender:"male"},s=[...window.membres,o];"function"==typeof window.updateMembresJSON?window.updateMembresJSON(s):window.membres=s,"function"==typeof bubble_fn_triggerNoeud&&bubble_fn_triggerNoeud(r)}))}if(e.length>0){const{p1:t,p2:d}=trouverPartenairesPrincipaux(e),r=e[0],o=e[e.length-1],s=new Konva.Group({x:0,y:30,listening:!0,visible:!1}),l=new Konva.Circle({x:0,y:0,radius:5,fill:"#eee",stroke:"#666",strokeWidth:2}),a=new Konva.Text({x:-5,y:-8,text:"+",fontSize:18,fontWeight:"bold",fill:"#666",visible:!1});s.add(l),s.add(a),r.group&&r.group.add(s),s.on("mouseenter",(()=>{document.body.style.cursor="pointer",l.radius(i),l.fill("yellow"),a.visible(!0),s.moveToTop(),layer.draw()})),s.on("mouseleave",(()=>{document.body.style.cursor="default",l.radius(5),l.fill("#eee"),a.visible(!1),layer.draw()})),r.group&&(r.group.on("mouseenter",(()=>{s.visible(!0),layer.draw()})),r.group.on("mouseleave",(()=>{s.visible(!1),layer.draw()}))),s.on("click",(()=>{n(t,"female")}));const m=new Konva.Group({x:140,y:30,listening:!0,visible:!1}),u=new Konva.Circle({x:0,y:0,radius:5,fill:"#eee",stroke:"#666",strokeWidth:2}),f=new Konva.Text({x:-5,y:-8,text:"+",fontSize:18,fontWeight:"bold",fill:"#666",visible:!1});m.add(u),m.add(f),o.group&&o.group.add(m),m.on("mouseenter",(()=>{document.body.style.cursor="pointer",u.radius(i),u.fill("yellow"),f.visible(!0),m.moveToTop(),layer.draw()})),m.on("mouseleave",(()=>{document.body.style.cursor="default",u.radius(5),u.fill("#eee"),f.visible(!1),layer.draw()})),o.group&&(o.group.on("mouseenter",(()=>{m.visible(!0),layer.draw()})),o.group.on("mouseleave",(()=>{m.visible(!1),layer.draw()}))),m.on("click",(()=>{n(d||t,"male")}))}}))}function trouverEnfantsEntreMembres(e,i){let n=[];if(e.pid===i.id||i.pid===e.id){const t=(e.expids||[]).map((e=>membres.find((i=>i.id===e)))).filter(Boolean),d=(i.expids||[]).map((e=>membres.find((i=>i.id===e)))).filter(Boolean),r=[e,...t],o=[i,...d];r.forEach((e=>{o.forEach((i=>{n.push(...function(e,i){let n,t;if("male"===e.gender&&"female"===i.gender)n=e.id,t=i.id;else{if("male"!==i.gender||"female"!==e.gender)return membres.filter((n=>n.fid===e.id&&n.mid===i.id||n.fid===i.id&&n.mid===e.id));n=i.id,t=e.id}return membres.filter((e=>e.fid===n&&e.mid===t))}(e,i))}))})),n=[...new Set(n)]}else{const t=i.expids&&i.expids.includes(e.id),d=e.expids&&e.expids.includes(i.id);if(t)n=membres.filter((n=>n.fid===i.id&&n.mid===e.id||n.fid===e.id&&n.mid===i.id));else if(d)n=membres.filter((n=>n.fid===e.id&&n.mid===i.id||n.fid===i.id&&n.mid===e.id));else{if(membres.filter((n=>n.expids&&n.expids.includes(e.id)&&n.expids.includes(i.id))).length>0)n=membres.filter((i=>i.fid===e.id||i.mid===e.id));else{membres.filter((n=>n.expids&&n.expids.includes(e.id)&&n.expids.includes(i.id))).length>0&&(n=membres.filter((e=>e.fid===i.id||e.mid===i.id)))}}}return n}function detecterEnfantsEntreNoeuds(e){e.forEach((e=>{for(let i=0;i<e.length-1;i++){const n=e[i],t=e[i+1],d=trouverEnfantsEntreMembres(n,t);console.log(`Entre "${n.name}" et "${t.name}" : enfants trouvés = [${d.map((e=>e.name)).join(", ")}]`)}}))}function tracerLiensNoeudsEnfants(e){const i={};e.forEach((e=>{for(let n=0;n<e.length-1;n++){const t=e[n],d=e[n+1],r=trouverEnfantsEntreMembres(t,d);if(0===r.length)continue;const o=t.lvl;i[o]||(i[o]=[]),i[o].push({mGauche:t,mDroite:d,enfants:r})}})),Object.entries(i).forEach((([e,i])=>{parseInt(e,10);i.forEach((({mGauche:e,mDroite:i,enfants:n},t)=>{const d=e.y+30,r=(e.x+140+i.x)/2,o=t%2==0?45:100*.55,s=selectedMemberId&&(selectedMemberId===e.id||selectedMemberId===i.id||n.some((e=>e.id===selectedMemberId)))?"#DAA520":t%2==0?"#666":"#999",l=d+5,a=d+o;groupDrag.add(new Konva.Line({points:[r,l,r,a],stroke:s,strokeWidth:2,listening:!1}));const m=n.map((e=>e.x+70)),u=Math.min(...m),f=Math.max(...m),c=Math.min(u,r)-1,h=Math.max(f,r)+1;n.length>1?groupDrag.add(new Konva.Line({points:[c,a,h,a],stroke:s,strokeWidth:2,listening:!1})):groupDrag.add(new Konva.Line({points:[r,a,m[0],a],stroke:s,strokeWidth:2,listening:!1})),n.forEach((e=>{const i=e.x+70,n=e.y;groupDrag.add(new Konva.Line({points:[i,a,i,n],stroke:s,strokeWidth:2,listening:!1}))}))}))}))}window.renderTree=function(){calculerEtAjusterNiveaux(window.membres);const e=constituerGroupesConjoints(window.membres),i=creerGroupesNiveaux(window.membres,e);window.groupesNiveaux=i,centrerTousLesMembres(window.membres),highlightSet=selectedMemberId?computeHighlightSet(selectedMemberId):new Set,console.log("--- Rendu de l'arbre ---"),console.log("Avant nettoyage groupDrag, nb enfants:",groupDrag.getChildren().length),[...groupDrag.getChildren()].forEach((e=>{e!==backgroundRect&&e.destroy()})),console.log("Après nettoyage groupDrag, nb enfants:",groupDrag.getChildren().length),e.forEach((e=>{e.forEach((e=>{drawMember(e,e.x,e.y)}))})),console.log("Nb membres dessinés:",window.membres.length),dessinerNoeudsGroupesConjoints(e),detecterEnfantsEntreNoeuds(e),tracerLiensNoeudsEnfants(e),layer.batchDraw()},window.updateMembresJSON=function(e){window.membres=e,stage.destroy(),initStage(),renderTree()},window.removeMemberById=function(e){const i=new Set([e]),n=[e],t=window.membres.find((i=>i.id===e));let d=null;if(t&&t.pid){const e=window.membres.find((e=>e.id===t.pid));!e||e.fid||e.mid||(d=e.id)}for(;n.length>0;){const e=n.shift(),t=window.membres.find((i=>i.id===e));t&&Array.isArray(t.expids)&&t.expids.forEach((e=>{i.has(e)||(i.add(e),n.push(e))})),window.membres.forEach((t=>{t.fid!==e&&t.mid!==e||i.has(t.id)||(i.add(t.id),n.push(t.id))}))}d&&!i.has(d)&&i.add(d);const r=window.membres.filter((e=>!i.has(e.id))).map((e=>{const n={...e};return i.has(n.fid)&&delete n.fid,i.has(n.mid)&&delete n.mid,i.has(n.pid)&&delete n.pid,Array.isArray(n.expids)&&(n.expids=n.expids.filter((e=>!i.has(e))),0===n.expids.length&&delete n.expids),n}));"function"==typeof window.updateMembresJSON?window.updateMembresJSON(r):(window.membres=r,renderTree())},window.initFamilyTree=function(){window.membres||(console.error("Les données des membres ne sont pas chargées."),window.membres=[]),initStage(),renderTree()},document.addEventListener("DOMContentLoaded",(function(){!1!==window.autoInitArbreFamille&&window.initFamilyTree()}));
